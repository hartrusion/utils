# This workflow will build a Java project with Ant and upload the JAR artifact.
# After a successful run it will delete older artifacts with the same artifact name,
# so only the newest "Package" artifact remains.
# Note: To allow deleting artifacts the workflow needs an elevated permission for actions (write).
name: Java CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# Allow this workflow to delete older artifacts via the GITHUB_TOKEN
permissions:
  actions: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Build with Ant
      run: ant -noinput -buildfile .github/build.xml jar

    - name: Upload JAR Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Package
        path: build/jar/*.jar
        # optional: if-no-files-found: warn

    - name: Delete older 'Package' artifacts (keep only the newest)
      if: ${{ success() }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        API_URL: https://api.github.com/repos/${{ github.repository }}
        ARTIFACT_NAME: Package
      run: |
        set -euo pipefail

        echo "Listing artifacts for repository $GITHUB_REPOSITORY ..."
        resp=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$API_URL/actions/artifacts?per_page=100")
        # Collect artifacts with the target name, each line: "<created_at> <id>"
        artifacts=$(echo "$resp" | jq -r '.artifacts[] | select(.name == env.ARTIFACT_NAME) | "\(.created_at) \(.id)"' | sort -r)

        if [ -z "$artifacts" ]; then
          echo "No artifacts named '$ARTIFACT_NAME' found — nothing to delete."
          exit 0
        fi

        echo "Found artifacts (most recent first):"
        echo "$artifacts"

        # Keep the first (most recent), delete the rest
        ids_to_delete=$(echo "$artifacts" | tail -n +2 | awk '{print $2}')
        if [ -z "$ids_to_delete" ]; then
          echo "Only the newest artifact exists — nothing to delete."
          exit 0
        fi

        for id in $ids_to_delete; do
          echo "Deleting artifact id=$id ..."
          del_resp=$(curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" "$API_URL/actions/artifacts/$id")
          # The DELETE call returns an empty body and 204 on success, curl -s won't show that;
          # we assume deletion succeeded if exit code is 0. Optionally check HTTP status for stronger guarantees.
          echo "Deleted artifact id=$id"
        done

        echo "Older 'Package' artifacts deleted. Only the newest remains."
